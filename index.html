<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox脚本生成与解析</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            text-align: right;
            color: #4a5568;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-size: 2rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        h1 img {
            width: 32px;
            height: 32px;
            margin-right: 10px;
            vertical-align: middle;
        }

        h1:hover {
            color: #667eea;
        }

        .subtitle {
            color: #718096;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .admin-trigger {
            display: none;
            margin: 1rem auto;
            padding: 0.5rem 1rem;
            background: #e2e8f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .admin-trigger.show {
            display: block;
        }

        .admin-login-hidden {
            display: none;
            margin: 1rem 0;
        }

        .admin-login-hidden input {
            width: 200px;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .admin-login-hidden button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            background: #f7fafc;
            border-radius: 10px;
            overflow: hidden;
            flex-direction: row; /* 确保水平布局 */
            justify-content: center;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #718096;
            max-width: 200px; /* 防止tabs过宽 */
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab.hidden {
            display: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .input-group {
            margin-bottom: 1rem;
            position: relative;
        }

        input[type="url"], input[type="password"], textarea, input[type="text"] {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            resize: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        input[type="url"], input[type="password"], input[type="text"] {
            height: auto;
            min-height: 60px;
        }

        textarea {
            height: 60px;
            min-height: 60px;
        }

        input[type="url"]:focus, input[type="password"]:focus, textarea:focus, input[type="text"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="url"]:hover, input[type="password"]:hover, textarea:hover, input[type="text"]:hover {
            border-color: #cbd5e0;
        }

        select {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            font-size: 1rem;
            margin: 1rem 0;
            outline: none;
            transition: all 0.3s ease;
        }

        select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            margin: 0.5rem;
            animation: pulse 2s infinite;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        @keyframes pulse {
            0% { box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 10px 20px rgba(102, 126, 234, 0.5); }
            100% { box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        }

        .injector-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(72, 187, 120, 0.3);
            margin: 0.5rem;
            display: inline-block;
        }

        .injector-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(72, 187, 120, 0.4);
        }

        .ban-btn {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(229, 62, 62, 0.3);
            margin: 0.5rem;
            display: inline-block;
        }

        .ban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(229, 62, 62, 0.4);
        }

        .unban-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .unban-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(72, 187, 120, 0.4);
        }

        .github-btn {
            background: linear-gradient(135deg, #24292e 0%, #1a1a1a 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(36, 41, 46, 0.3);
            margin: 0.5rem;
            display: inline-block;
        }

        .github-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(36, 41, 46, 0.4);
        }

        .example {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #718096;
            font-style: italic;
        }

        .output {
            margin-top: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 10px;
            text-align: left;
            display: none;
            animation: fadeIn 0.3s ease;
            max-height: 300px;
            overflow-y: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .output.show {
            display: block;
        }

        .output h3, .output h4 {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .output ul {
            list-style: none;
            padding: 0;
        }

        .output li {
            margin: 0.5rem 0;
        }

        .output a {
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem;
            background: white;
            border-radius: 5px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .output a:hover {
            background: #667eea;
            color: white;
        }

        .injector-list {
            list-style: none;
            padding: 0;
        }

        .injector-list li {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .banned-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        .banned-list li {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #fed7d7;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-info {
            background: #f0fff4;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid #9ae6b4;
        }

        .script-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 1rem;
            position: relative;
            word-break: break-all; /* 防止ASCII长字符串溢出 */
            white-space: pre-wrap;
            max-width: 100%;
            overflow-x: auto;
            box-sizing: border-box;
        }

        .script-code pre {
            margin: 0;
            padding-right: 2.5rem; /* 为按钮留空间 */
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #48bb78;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 10;
        }

        .copy-btn:hover {
            background: #38a169;
        }

        .alert {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            background: #fed7d7;
            color: #c53030;
            display: none;
        }

        .alert.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .confirm-ui {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }

        .confirm-ui.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .confirm-ui h3 {
            margin-bottom: 1rem;
            color: #4a5568;
        }

        .confirm-ui .button {
            margin: 0.5rem;
        }

        .loading {
            margin: 1rem 0;
            color: #718096;
            font-style: italic;
        }

        .admin-login {
            margin: 1rem 0;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.show {
            display: block;
        }

        .github-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1rem 0;
        }

        .github-inputs input {
            max-width: 300px;
        }

        .tabs.admin-mode .tab:not([data-tab="admin"]) {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info" id="userInfo">
            <div>IP: <span id="displayIP">加载中...</span></div>
        </div>
        <h1 onclick="toggleAdminTrigger()">
            <img src="https://imgshare.cc/api/image/proxy?id=35uye48i&token=eyJpbWFnZUlkIjoiMzV1eWU0OGkiLCJ0aW1lc3RhbXAiOjE3NjE5MjQ5NjkxMjIsInNpZ25hdHVyZSI6ImM2NzcxYjM3Y2YzYjBiNmRkZmQ0YTQ3Y2M4MTMzMGZmY2RmODMxYjFjZmIxNzU1N2ZkNmJlYzE4YjA0MzM4OTMifQ" alt="标题图标">
            Roblox脚本生成与解析
        </h1>
        <div class="subtitle">黄某制作</div>
        <div class="admin-trigger" id="adminTrigger" onclick="showHiddenLogin()">管理员登录</div>
        <div class="admin-login-hidden" id="hiddenLogin">
            <input type="password" id="adminPassword" placeholder="输入管理员密码" />
            <button onclick="loginAdmin()">登录</button>
        </div>

        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="raw" onclick="switchTab('raw')">Raw URL 解析</button>
            <button class="tab" data-tab="ascii" onclick="switchTab('ascii')">ASCII 编码转换</button>
            <button class="tab" data-tab="ninja" onclick="switchTab('ninja')">忍者卡密自动获取</button>
            <button class="tab" data-tab="injectors" onclick="switchTab('injectors')">注入器下载</button>
        </div>

        <!-- Raw URL Tab -->
        <div id="raw" class="tab-content active">
            <div class="input-group">
                <input type="url" id="rawUrl" placeholder="输入 GitHub Raw URL" />
                <div class="example">示例：https://raw.githubusercontent.com/用户名字/仓库/refs/heads/main/文件名</div>
            </div>
            <button class="button" onclick="parseRawUrl()">解析 URL</button>
            <div id="rawOutput" class="output"></div>
            <div id="confirmUi" class="confirm-ui"></div>
        </div>

        <!-- ASCII Tab -->
        <div id="ascii" class="tab-content">
            <div class="input-group">
                <textarea id="asciiInput" placeholder="输入 ASCII 编码的 URL, 原 URL 或 loadstring(game:HttpGet('URL'))()"></textarea>
                <div class="example">支持 ASCII 编码解析、原 URL 转 ASCII 或带 loadstring 的脚本解析</div>
            </div>
            <button class="button" onclick="handleAscii()">转换/解析</button>
            <div id="asciiOutput" class="output"></div>
        </div>

        <!-- Ninja Key Tab -->
        <div id="ninja" class="tab-content">
            <div class="input-group">
                <input type="url" id="ninjaUrl" placeholder="输入忍者卡密 URL" />
                <div class="example">示例：https://auth.platoboost.app/a?d=1xqbuwmPGUfK4EvYVOARcsfwaYbaD2EaplEuUKYkzBeg85dOTkQ7oKdOEGMJCFzlSIrGYpPSS6z1Pjmyy5wL61NQItJrQ4wdQgcvVa8NyRd2KkQohzWHeRc3AL15Pghqi6qWLpYiTEWpidk5ACAP2PzY90aJ7qCNbUcb7mtFNNtobF07c3tL7PTWvwezhlC9Mb5WJYhYx6NX5EuXG9Zy1saZu7Gd7RCcQuW9tV1e381JnOIO95f2rJeu3xVjuYh7G5ZncOOsSSszukmfIhRMOlNHfY1ht7YyfD2qlFgaB58Y9SeOtUU0sMJ8EXwNRkahMi2YmeiDThtlRmIvYOMY81TXp6QwGKS7jybwNIqRyfbnvoZHDkOC8ezWogec6nJ2NkGRGkzfO65N6eTaTeKhMpyKN5UdfzfQoFZdQzeoYdMBwUBGyNj0YmfVQRnH5mVCTXWBR0GZ43Tdmf78Zwj</div>
            </div>
            <button class="button" onclick="getNinjaKey()">自动获取密钥</button>
            <div id="ninjaOutput" class="output"></div>
        </div>

        <!-- Injectors Tab -->
        <div id="injectors" class="tab-content">
            <h3>注入器下载地址</h3>
            <ul class="injector-list">
                <li>
                    <strong>Trigon</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://trigonevo.com/android/')">下载 Trigon</button>
                </li>
                <li>
                    <strong>Deltaexecuter (忍者注入器)</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://delta.webfiles.pro/android.html')">下载 Deltaexecuter</button>
                </li>
                <li>
                    <strong>Ronix</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://wearedevs.net/d/Ronix')">下载 Ronix</button>
                </li>
                <li>
                    <strong>Vegax</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://github.com/1f0yt/community/releases/download/Vegax/Vega.X.apk')">下载 Vegax</button>
                </li>
                <li>
                    <strong>Codex</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://codex.lol/android')">下载 Codex</button>
                </li>
                <li>
                    <strong>Krnl</strong><br>
                    <button class="injector-btn" onclick="jumpTo('https://krnl.webfiles.pro/android.html')">下载 Krnl</button>
                </li>
            </ul>
        </div>

        <!-- Admin Tab (initially hidden) -->
        <div id="admin" class="tab-content" style="display: none;">
            <div id="adminPanel" class="admin-panel show">
                <h3>管理员面板</h3>
                <button class="button" onclick="loadCurrentInfo()">加载当前 IP</button>
                <div id="currentInfo" class="current-info" style="display: none;">
                    <p><strong>当前 IP:</strong> <span id="currentIP"></span></p>
                    <button class="ban-btn" onclick="quickBan('IP')">快速封禁当前 IP</button>
                </div>
                <div class="input-group">
                    <input type="text" id="banIP" placeholder="输入 IP 地址" />
                </div>
                <button class="ban-btn" onclick="banItem('IP')">封禁 IP</button>
                <div class="input-group">
                    <input type="text" id="unbanIP" placeholder="输入要解禁的 IP 地址" />
                </div>
                <button class="unban-btn" onclick="unbanSpecificItem('IP')" style="display: inline-block; margin: 0.5rem;">解禁指定 IP</button>
                <div id="bannedList" class="output">
                    <h4>已封禁 IP 列表：</h4>
                    <ul class="banned-list" id="bannedIPs"></ul>
                </div>
                <h4>GitHub 上传封禁列表</h4>
                <div class="github-inputs">
                    <input type="text" id="githubToken" placeholder="GitHub Personal Access Token" />
                    <input type="text" id="githubOwner" placeholder="Repository Owner (e.g., username)" />
                    <input type="text" id="githubRepo" placeholder="Repository Name" />
                    <input type="text" id="githubPath" placeholder="File Path (e.g., banned.json)" />
                    <input type="text" id="githubMessage" placeholder="Commit Message (default: Update banned list)" value="Update banned list" />
                </div>
                <button class="github-btn" onclick="uploadToGitHub()">上传到 GitHub</button>
                <button class="button" onclick="logoutAdmin()">登出</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>
    </div>

    <script>
        let branches = [];
        let files = [];
        let currentRepo = '';
        let isAdminLoggedIn = false;
        const ADMIN_PASSWORD = 'QfEpZoeTObkVSwiLdGzRAfV';

        // 优化后的加载用户IP函数（仅IP）
        async function loadUserInfo() {
            // IP
            let ip = '无法获取';
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                if (!ipRes.ok) throw new Error(`HTTP ${ipRes.status}`);
                const ipData = await ipRes.json();
                ip = ipData.ip;
            } catch (e) {
                console.error('IP 获取失败:', e);
                // 备选：用 httpbin
                try {
                    const altRes = await fetch('https://httpbin.org/ip');
                    const altData = await altRes.json();
                    ip = altData.origin;
                } catch (altE) {
                    console.error('备选 IP 也失败:', altE);
                }
            }
            document.getElementById('displayIP').textContent = ip;
        }

        loadUserInfo();

        function toggleAdminTrigger() {
            const trigger = document.getElementById('adminTrigger');
            if (trigger.classList.contains('show')) {
                trigger.classList.remove('show');
                document.getElementById('hiddenLogin').style.display = 'none';
            } else {
                trigger.classList.add('show');
            }
        }

        function showHiddenLogin() {
            document.getElementById('hiddenLogin').style.display = 'block';
            document.getElementById('adminPassword').focus();
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                // 隐藏触发器和登录框
                document.getElementById('adminTrigger').style.display = 'none';
                document.getElementById('hiddenLogin').style.display = 'none';
                // 显示管理员tab内容并隐藏其他tabs
                document.getElementById('admin').style.display = 'block';
                document.getElementById('tabs').classList.add('admin-mode');
                switchTab('admin');
                loadBannedList();
                showAlert('登录成功！');
            } else {
                showAlert('密码错误！');
            }
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('admin').style.display = 'none';
            document.getElementById('tabs').classList.remove('admin-mode');
            document.getElementById('adminTrigger').classList.remove('show');
            document.getElementById('hiddenLogin').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            switchTab('raw'); // 返回默认tab
            document.getElementById('currentInfo').style.display = 'none';
        }

        function switchTab(tabName) {
            if (isAdminLoggedIn && tabName !== 'admin') return; // 管理员模式下只允许admin tab

            // 移除所有 tab-content 的 active 类，确保只显示选中的
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // 移除所有 tab 的 active 类
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // 添加选中 tab-content 的 active 类
            const selectedContent = document.getElementById(tabName);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }
            // 添加选中 tab 的 active 类
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
        }

        // 优化后的加载当前信息函数（仅IP）
        async function loadCurrentInfo() {
            // IP
            let ip = '无法获取';
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                if (!ipRes.ok) throw new Error(`HTTP ${ipRes.status}`);
                const ipData = await ipRes.json();
                ip = ipData.ip;
            } catch (e) {
                console.error('当前 IP 获取失败:', e);
                // 备选：用 httpbin
                try {
                    const altRes = await fetch('https://httpbin.org/ip');
                    const altData = await altRes.json();
                    ip = altData.origin;
                } catch (altE) {
                    console.error('备选 IP 也失败:', altE);
                }
            }
            document.getElementById('currentIP').textContent = ip;

            document.getElementById('currentInfo').style.display = 'block';
            showAlert('当前 IP 加载成功！');
        }

        function quickBan(type) {
            if (type === 'IP') {
                const ip = document.getElementById('currentIP').textContent;
                if (!ip || ip === '无法获取') {
                    showAlert('请先加载当前信息');
                    return;
                }
                document.getElementById('banIP').value = ip;
                banItem('IP');
            }
        }

        function banItem(type) {
            let value;
            if (type === 'IP') {
                value = document.getElementById('banIP').value.trim();
                if (!value) {
                    showAlert('请输入 IP 地址');
                    return;
                }
                let bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
                if (!bannedIPs.includes(value)) {
                    bannedIPs.push(value);
                    localStorage.setItem('bannedIPs', JSON.stringify(bannedIPs));
                    showAlert('IP 已封禁');
                    loadBannedList();
                } else {
                    showAlert('IP 已存在于封禁列表');
                }
            }
        }

        function unbanSpecificItem(type) {
            let value;
            if (type === 'IP') {
                value = document.getElementById('unbanIP').value.trim();
                if (!value) {
                    showAlert('请输入要解禁的 IP 地址');
                    return;
                }
                let bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
                const index = bannedIPs.indexOf(value);
                if (index > -1) {
                    bannedIPs.splice(index, 1);
                    localStorage.setItem('bannedIPs', JSON.stringify(bannedIPs));
                    showAlert('IP 已解禁');
                    loadBannedList();
                    document.getElementById('unbanIP').value = '';
                } else {
                    showAlert('IP 不存在于封禁列表');
                }
            }
        }

        function loadBannedList() {
            const bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
            const ipsList = document.getElementById('bannedIPs');
            ipsList.innerHTML = bannedIPs.map(ip => `<li>${ip} <button class="unban-btn" onclick="unbanItem('IP', '${ip.replace(/'/g, "\\'")}')">解禁</button></li>`).join('');
        }

        function unbanItem(type, value) {
            if (type === 'IP') {
                let bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
                const index = bannedIPs.indexOf(value);
                if (index > -1) {
                    bannedIPs.splice(index, 1);
                    localStorage.setItem('bannedIPs', JSON.stringify(bannedIPs));
                    showAlert('IP 已解禁');
                }
            }
            loadBannedList();
        }

        async function uploadToGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            const owner = document.getElementById('githubOwner').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const path = document.getElementById('githubPath').value.trim();
            const message = document.getElementById('githubMessage').value.trim() || 'Update banned list';

            if (!token || !owner || !repo || !path) {
                showAlert('请填写所有 GitHub 字段');
                return;
            }

            const bannedIPs = JSON.parse(localStorage.getItem('bannedIPs') || '[]');
            const content = {
                ips: bannedIPs
            };
            const base64Content = btoa(JSON.stringify(content, null, 2));

            try {
                // 先获取文件 SHA (如果存在)
                const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                let sha = null;
                if (getRes.ok) {
                    const getData = await getRes.json();
                    sha = getData.sha;
                }

                // 创建/更新文件
                const putData = {
                    message: message,
                    content: base64Content,
                    ...(sha && { sha: sha })
                };

                const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(putData)
                });

                if (putRes.ok) {
                    showAlert('上传到 GitHub 成功！');
                } else {
                    const err = await putRes.json();
                    showAlert('上传失败: ' + err.message);
                }
            } catch (e) {
                showAlert('上传错误: ' + e.message);
            }
        }

        async function getNinjaKey() {
            const url = document.getElementById('ninjaUrl').value.trim();
            const output = document.getElementById('ninjaOutput');
            if (!url) {
                showAlert('请输入有效的 URL');
                return;
            }
            output.innerHTML = '<div class="loading">正在获取密钥...</div>';
            output.classList.add('show');
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const html = await res.text();
                // 提取 FREE_ 开头的约20位密钥
                const keyMatch = html.match(/FREE_[A-Z0-9]{20}/);
                if (keyMatch) {
                    const key = keyMatch[0];
                    output.innerHTML = `
                        <h3>获取成功！</h3>
                        <div class="script-code">
                            <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(key)}')">复制密钥</button>
                            <pre>${escapeForHtml(key)}</pre>
                        </div>
                    `;
                } else {
                    output.innerHTML = '<p>你未完成解卡，请解卡完后再来输入</p>';
                }
            } catch (e) {
                output.innerHTML = '<p>获取失败: ' + e.message + '</p>';
                showAlert('获取密钥失败，请检查URL或网络');
            }
        }

        function jumpTo(url) {
            window.open(url, '_blank');
        }

        async function fetchBranches(owner, repo) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/branches`);
                if (!response.ok) throw new Error('Failed to fetch branches');
                branches = await response.json();
                return branches.map(b => b.name);
            } catch (e) {
                showAlert('获取分支失败：' + e.message + ' (可能需代理或检查网络)');
                return [];
            }
        }

        async function fetchFiles(owner, repo, branch) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents?ref=${branch}`);
                if (!response.ok) throw new Error('Failed to fetch files');
                const data = await response.json();
                files = data.filter(item => item.type === 'file' && (item.name.endsWith('.lua') || item.name.endsWith('.js'))); // 假设脚本文件为 .lua 或 .js
                return files.map(f => ({ name: f.name, url: f.download_url, path: f.path }));
            } catch (e) {
                showAlert('获取文件失败：' + e.message + ' (可能需代理或检查网络)');
                return [];
            }
        }

        function parseRawUrl() {
            const rawUrl = document.getElementById('rawUrl').value.trim();
            const alertDiv = document.getElementById('alert');
            const outputDiv = document.getElementById('rawOutput');
            const confirmUi = document.getElementById('confirmUi');

            if (!rawUrl) {
                showAlert('请输入有效的 GitHub Raw URL');
                return;
            }

            const url = new URL(rawUrl);
            if (url.hostname !== 'raw.githubusercontent.com') {
                showAlert('请输入有效的 GitHub Raw URL（必须以 raw.githubusercontent.com 开头）');
                return;
            }

            const pathParts = url.pathname.split('/').filter(part => part.length > 0);
            if (pathParts.length < 2) {
                showAlert('URL 格式无效，无法提取仓库信息');
                return;
            }

            const owner = pathParts[0];
            const repo = pathParts[1];
            currentRepo = `${owner}/${repo}`;
            const githubUrl = `https://github.com/${owner}/${repo}`;

            outputDiv.innerHTML = `
                <h3>解析结果：</h3>
                <ul>
                    <li><a href="${githubUrl}" target="_blank">仓库首页：${owner}/${repo}</a></li>
                </ul>
                <div class="loading">正在加载分支...</div>
                <div id="branchSelectContainer"></div>
                <div id="fileList"></div>
            `;
            outputDiv.classList.add('show');

            // 获取分支
            fetchBranches(owner, repo).then(branchNames => {
                const loadingDiv = outputDiv.querySelector('.loading');
                if (loadingDiv) loadingDiv.remove();

                if (branchNames.length === 0) {
                    outputDiv.innerHTML += '<p>无分支可用。</p>';
                    return;
                }

                const branchSelectContainer = document.getElementById('branchSelectContainer');
                branchSelectContainer.innerHTML = `
                    <h4>选择分支：</h4>
                    <select id="branchSelect" onchange="loadFiles()">
                        <option value="">请选择分支</option>
                        ${branchNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                `;

                // 默认加载主分支（通常是 main 或 master）
                const defaultBranch = branchNames.find(b => b === 'main' || b === 'master') || branchNames[0];
                if (defaultBranch) {
                    document.getElementById('branchSelect').value = defaultBranch;
                    loadFiles();
                }
            });

            // 生成 Roblox 脚本（基于输入URL）
            const script = `loadstring(game:HttpGet("${rawUrl}"))()`;
            const scriptDiv = document.createElement('div');
            scriptDiv.className = 'script-code';
            scriptDiv.innerHTML = `
                <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(script)}')">复制脚本</button>
                <pre>${escapeForHtml(script)}</pre>
            `;
            outputDiv.appendChild(scriptDiv);

            // 生成确认 UI
            confirmUi.innerHTML = `
                <h3>确认跳转到仓库？</h3>
                <button class="button" onclick="confirmJump('${githubUrl}')">是的，跳转</button>
                <button class="button" style="background: #e53e3e;" onclick="cancelJump()">取消</button>
            `;
            confirmUi.classList.add('show');

            alertDiv.classList.remove('show');
        }

        async function loadFiles() {
            const select = document.getElementById('branchSelect');
            if (!select) return;
            const branch = select.value;
            const fileListDiv = document.getElementById('fileList');
            if (!branch || !fileListDiv) return;

            fileListDiv.innerHTML = '<div class="loading">正在加载文件...</div>';

            const pathParts = currentRepo.split('/');
            const owner = pathParts[0];
            const repo = pathParts[1];

            const fileList = await fetchFiles(owner, repo, branch);
            const loadingDiv = fileListDiv.querySelector('.loading');
            if (loadingDiv) loadingDiv.remove();

            if (fileList.length === 0) {
                fileListDiv.innerHTML = '<p>无脚本文件（.lua/.js）。</p>';
                return;
            }

            fileListDiv.innerHTML = `
                <h4>分支 "${branch}" 中的脚本文件：</h4>
                <ul>
                    ${fileList.map(f => `<li><a href="${f.url}" target="_blank">${escapeForHtml(f.name)}</a></li>`).join('')}
                </ul>
            `;
        }

        function confirmJump(githubUrl) {
            window.open(githubUrl, '_blank');
            document.getElementById('confirmUi').classList.remove('show');
        }

        function cancelJump() {
            document.getElementById('confirmUi').classList.remove('show');
        }

        function handleAscii() {
            const input = document.getElementById('asciiInput').value.trim();
            const outputDiv = document.getElementById('asciiOutput');
            const alertDiv = document.getElementById('alert');

            if (!input) {
                showAlert('请输入内容');
                return;
            }

            let url, asciiStr, hasLoadstring = false;

            // 检查是否包含 loadstring
            const loadstringMatch = input.match(/loadstring\(game:HttpGet\(['"]([^'"]+)['"]\)\)\(\)/);
            if (loadstringMatch) {
                url = loadstringMatch[1];
                hasLoadstring = true;
            } else if (input.startsWith('\\') && input.match(/\\(\d{1,3})/g)) {
                // ASCII 解析
                try {
                    url = parseAsciiToUrl(input);
                } catch (e) {
                    showAlert('无效的 ASCII 编码');
                    return;
                }
            } else {
                // 假设是原 URL
                url = input;
            }

            // 生成 ASCII
            asciiStr = urlToAscii(url);

            // 如果输入是 URL，转 ASCII 并显示两种脚本
            if (!hasLoadstring && !input.startsWith('\\')) {
                const urlScript = `loadstring(game:HttpGet("${url}"))()`;
                const asciiScript = `loadstring(game:HttpGet("${asciiStr}"))()`;
                outputDiv.innerHTML = `
                    <h3>URL 转 ASCII 结果：</h3>
                    <p>原 URL：${escapeForHtml(url)}</p>
                    <p>ASCII 编码：${escapeForHtml(asciiStr)}</p>
                    <div class="script-code">
                        <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(urlScript)}')">复制 URL 脚本</button>
                        <pre>${escapeForHtml(urlScript)}</pre>
                    </div>
                    <div class="script-code">
                        <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(asciiScript)}')">复制 ASCII 脚本</button>
                        <pre>${escapeForHtml(asciiScript)}</pre>
                    </div>
                `;
            } else {
                // 显示解析结果：两种脚本
                const urlScript = `loadstring(game:HttpGet("${url}"))()`;
                const asciiScript = `loadstring(game:HttpGet("${asciiStr}"))()`;
                let html = `
                    <h3>解析结果：</h3>
                    <p>提取的 URL：${escapeForHtml(url)}</p>
                `;
                html += `
                    <div class="script-code">
                        <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(urlScript)}')">复制 URL 脚本</button>
                        <pre>${escapeForHtml(urlScript)}</pre>
                    </div>
                    <div class="script-code">
                        <button class="copy-btn" onclick="copyToClipboard('${escapeForHtml(asciiScript)}')">复制 ASCII 脚本</button>
                        <pre>${escapeForHtml(asciiScript)}</pre>
                    </div>
                `;
                outputDiv.innerHTML = html;
            }

            outputDiv.classList.add('show');
            alertDiv.classList.remove('show');
        }

        function parseAsciiToUrl(asciiStr) {
            const matches = asciiStr.match(/\\(\d{1,3})/g);
            if (!matches) throw new Error('Invalid ASCII');
            let url = '';
            for (let match of matches) {
                const code = parseInt(match.slice(1));
                if (code > 255) throw new Error('Invalid char code');
                url += String.fromCharCode(code);
            }
            return url;
        }

        function urlToAscii(url) {
            let ascii = '';
            for (let i = 0; i < url.length; i++) {
                const code = url.charCodeAt(i);
                if (code > 255) throw new Error('URL contains non-ASCII chars');
                ascii += `\\${code}`;
            }
            return ascii;
        }

        function escapeForHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function copyToClipboard(text) {
            // 解码HTML实体以确保复制原始文本
            const decodedText = text.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#039;/g, "'");
            navigator.clipboard.writeText(decodedText).then(() => {
                showAlert('已复制到剪贴板！');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = decodedText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('已复制到剪贴板！');
            });
        }

        function showAlert(message) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.classList.add('show');
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 3000);
        }

        // 按 Enter 键触发
        document.getElementById('rawUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                parseRawUrl();
            }
        });

        document.getElementById('asciiInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleAscii();
            }
        });

        document.getElementById('ninjaUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getNinjaKey();
            }
        });

        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginAdmin();
            }
        });
    </script>
</body>
</html>
